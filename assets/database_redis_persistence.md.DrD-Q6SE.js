import{_ as a,c as n,o as e,ah as l}from"./chunks/framework.BrJYEL96.js";const u=JSON.parse('{"title":"Redis持久化","description":"","frontmatter":{},"headers":[],"relativePath":"database/redis/persistence.md","filePath":"database/redis/persistence.md","lastUpdated":1738670768000}'),p={name:"database/redis/persistence.md"};function r(o,s,i,c,t,d){return e(),n("div",null,s[0]||(s[0]=[l(`<h1 id="redis持久化" tabindex="-1">Redis持久化 <a class="header-anchor" href="#redis持久化" aria-label="Permalink to &quot;Redis持久化&quot;">​</a></h1><h3 id="redis持久化的三种方式" tabindex="-1">Redis持久化的三种方式 <a class="header-anchor" href="#redis持久化的三种方式" aria-label="Permalink to &quot;Redis持久化的三种方式&quot;">​</a></h3><ul><li>RDB：在指定的时间间隔对数据进行快照存储，类似于Mysql的dump备份文件。</li><li>AOF：记录每次对服务器写的操作，当服务器重启的时候会重新执行这些命令来回复原始的数据（Mysql的binlog）。</li><li>RDB与AOF混合使用：redis4.0新特性。</li></ul><h2 id="rdb" tabindex="-1">RDB <a class="header-anchor" href="#rdb" aria-label="Permalink to &quot;RDB&quot;">​</a></h2><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki one-dark-pro vp-code" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;"># 900s内如果超过1个key改动，则发起快照保存，阻塞</span></span>
<span class="line"><span style="color:#61AFEF;">save</span><span style="color:#D19A66;"> 900</span><span style="color:#D19A66;"> 10</span><span style="color:#ABB2BF;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 手动触发 非阻塞 从复制主服务器</span></span>
<span class="line"><span style="color:#61AFEF;">bgsave</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>客户端发送shutdown，系统会先执行save命令阻塞客户端，然后关闭服务器</p><h3 id="优点" tabindex="-1">优点： <a class="header-anchor" href="#优点" aria-label="Permalink to &quot;优点：&quot;">​</a></h3><ol><li>紧凑型的二进制文件</li><li>fork子进程性能最大化</li><li>启动效率高</li></ol><h3 id="缺点" tabindex="-1">缺点： <a class="header-anchor" href="#缺点" aria-label="Permalink to &quot;缺点：&quot;">​</a></h3><ol><li>生成快照的时机问题</li><li>fork子进程的开销问题</li></ol><h2 id="aof" tabindex="-1">AOF <a class="header-anchor" href="#aof" aria-label="Permalink to &quot;AOF&quot;">​</a></h2><p>AOF(append only file)，只追加文件，</p><h3 id="开启" tabindex="-1">开启 <a class="header-anchor" href="#开启" aria-label="Permalink to &quot;开启&quot;">​</a></h3><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki one-dark-pro vp-code" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;"># 配置</span></span>
<span class="line"><span style="color:#61AFEF;">appendonly</span><span style="color:#98C379;"> yes</span></span>
<span class="line"><span style="color:#61AFEF;">appendfilename</span><span style="color:#98C379;"> &#39;appendonly.aof&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">dir</span><span style="color:#98C379;"> /usr/local/redis/data</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="同步策略" tabindex="-1">同步策略 <a class="header-anchor" href="#同步策略" aria-label="Permalink to &quot;同步策略&quot;">​</a></h3><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki one-dark-pro vp-code" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;"># 每秒同步一次，缺省</span></span>
<span class="line"><span style="color:#61AFEF;">appendfsync</span><span style="color:#98C379;"> everysec</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 有数据修改时写入aof文件</span></span>
<span class="line"><span style="color:#61AFEF;">appendfsync</span><span style="color:#98C379;"> always</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#从不</span></span>
<span class="line"><span style="color:#61AFEF;">appendfsync</span><span style="color:#98C379;"> no</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="常用配置" tabindex="-1">常用配置 <a class="header-anchor" href="#常用配置" aria-label="Permalink to &quot;常用配置&quot;">​</a></h3><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki one-dark-pro vp-code" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;"># 每秒同步一次，缺省</span></span>
<span class="line"><span style="color:#61AFEF;">appendfsync</span><span style="color:#98C379;"> everysec</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># aof重写期间是否禁止fsync</span></span>
<span class="line"><span style="color:#61AFEF;">no-appendfsync-on-rewrite</span><span style="color:#98C379;"> no</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#当前aof文件大于多少字节后才触发重写</span></span>
<span class="line"><span style="color:#61AFEF;">auto-aof-rewrite-min-size</span><span style="color:#98C379;"> 64mb</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 当前写入日志文件的大小超过上一次rewrite之后文件的大小的100%时，也就是2倍时触发rewrite</span></span>
<span class="line"><span style="color:#61AFEF;">auto-aof-rewrite-percentage</span><span style="color:#D19A66;"> 100</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># 如果aof文件结尾损坏，redis启动时是否人载入aof文件</span></span>
<span class="line"><span style="color:#61AFEF;">aof-load-truncated</span><span style="color:#98C379;"> yes</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="混合模式rdb-aof" tabindex="-1">混合模式RDB&amp;AOF <a class="header-anchor" href="#混合模式rdb-aof" aria-label="Permalink to &quot;混合模式RDB&amp;AOF&quot;">​</a></h2><p>开启 <code>aof-use-rdb-preamble true</code>， 通过<code>bgrwriteaof</code>命令完成</p><h3 id="二者动态切换" tabindex="-1">二者动态切换 <a class="header-anchor" href="#二者动态切换" aria-label="Permalink to &quot;二者动态切换&quot;">​</a></h3><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki one-dark-pro vp-code" style="background-color:#282c34;color:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#7F848E;font-style:italic;">#现将rdb文件备份</span></span>
<span class="line"><span style="color:#61AFEF;">cp</span><span style="color:#98C379;"> dump.rdb</span><span style="color:#98C379;"> dump.rdb.bak</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#开启aof</span></span>
<span class="line"><span style="color:#61AFEF;">redis-cli</span><span style="color:#98C379;"> config</span><span style="color:#98C379;"> set</span><span style="color:#98C379;"> appendonly</span><span style="color:#98C379;"> yes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#关闭rdb</span></span>
<span class="line"><span style="color:#61AFEF;">redis-cli</span><span style="color:#98C379;"> config</span><span style="color:#98C379;"> set</span><span style="color:#98C379;"> save</span><span style="color:#98C379;"> &#39;&#39;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div>`,22)]))}const y=a(p,[["render",r]]);export{u as __pageData,y as default};
